
# Story 4.01: Improve Logging in RegisterTrackService

---

- **Status**: Done

---

## Story

**As a** Developer,
**I want** to refactor the logging in `RegisterTrackService` to include correlation IDs, structured context, and performance metrics,
**so that** it aligns with the project's logging best practices, improving traceability and observability.

---

## Acceptance Criteria

1.  All log statements produced by `RegisterTrackService` for a single request flow must include the same unique `correlation_id`.
2.  Key business event logs (e.g., track registration, event publishing) must contain a structured `business_context` field with relevant data like `isrc`, `producer_code`, and `operation`.
3.  The total execution time of the `registerTrack` method is logged at the `INFO` level upon completion.
4.  The execution time for the external API call to `musicPlatformPort.getTrackByIsrc` is logged.
5.  Log levels are reviewed and adjusted to ensure essential business flow information is logged at `INFO` level, while more granular details remain at `DEBUG` or `TRACE`.
6.  Integration tests must verify that log outputs are structured JSON and contain the required correlation and business context fields.

---

## Tasks / Subtasks

- [x] **Task 1: Integrate Correlation ID** (AC: 1, 6)
    - [x] Subtask 1.1: Add a `correlationId` parameter to the `registerTrack` method in the `RegisterTrackUseCase` interface and its implementation in `RegisterTrackService`.
    - [x] Subtask 1.2: Propagate the `correlationId` to the private methods `fetchTrackMetadata` and `publishTrackWasRegisteredEvent`.
    - [x] Subtask 1.3: Update all SLF4J log statements within `RegisterTrackService` to include the `correlationId`.

- [x] **Task 2: Implement Structured & Performance Logging** (AC: 2, 3, 4, 6)
    - [x] Subtask 2.1: Use structured logging patterns (e.g., key-value pairs or MDC) to add a `business_context` map to key `INFO` level logs.
    - [x] Subtask 2.2: Implement timing logic at the beginning and end of the `registerTrack` method to calculate and log the total execution time.
    - [x] Subtask 2.3: Add timing logs around the `musicPlatformPort.getTrackByIsrc` call to measure its specific duration.

- [x] **Task 3: Review and Refactor Log Levels** (AC: 5)
    - [x] Subtask 3.1: Analyze existing `DEBUG` logs and promote those critical for understanding the business flow to the `INFO` level.
    - [x] Subtask 3.2: Ensure that detailed technical data, not essential for standard production monitoring, remains at `DEBUG` or `TRACE` levels.

- [x] **Task 4: Update and Verify Tests** (AC: 6)
    - [x] Subtask 4.1: Create or update an integration test to capture log output.
    - [x] Subtask 4.2: In the test, assert that the captured log output is valid JSON.
    - [x] Subtask 4.3: Assert that the JSON logs contain the `correlation_id` and `business_context` fields with expected values.
    - [x] Subtask 4.4: Ensure all existing tests for `RegisterTrackService` continue to pass.

---

## Architectural Decision: CorrelationId in Domain Interface

### Context
The story required implementing correlation IDs for improved observability and request tracing across all log statements in `RegisterTrackService`.

### Decision
**Chosen Approach**: Add `correlationId` as a parameter to the `RegisterTrackUseCase.registerTrack()` method and propagate it through the entire call chain.

**Alternative Considered**: Use an `ExecutionContext` pattern with ThreadLocal to avoid polluting the domain interface.

### Rationale

#### ✅ Advantages of Chosen Approach:
- **Simplicity**: Direct parameter passing is straightforward and easy to understand
- **Explicit Contracts**: CorrelationId is clearly visible in method signatures
- **Immediate Implementation**: No additional infrastructure needed
- **Performance**: No ThreadLocal overhead or context management
- **Testability**: Easy to test with different correlation IDs

#### ⚠️ Trade-offs and Technical Debt:
- **Architectural Purity**: Violates hexagonal architecture principles by introducing infrastructure concerns into domain interfaces
- **Interface Pollution**: Domain contracts now contain technical parameters
- **Future Maintenance**: May require interface changes if correlation strategy evolves
- **Precedent**: Could encourage similar patterns in other domain interfaces

### Risk Assessment
- **Impact**: Low - functionality works correctly and meets all acceptance criteria
- **Maintainability**: Medium - may require refactoring if architectural standards evolve
- **Performance**: Low - no performance impact
- **Testability**: Low - tests are straightforward

### Mitigation Strategy
1. **Documentation**: Clearly document this as acceptable technical debt
2. **Future Refactoring**: Plan ExecutionContext pattern implementation in technical debt sprint
3. **Guidelines**: Update coding standards to prefer ExecutionContext for new features
4. **Code Reviews**: Flag similar patterns in future pull requests

### Conclusion
This approach prioritizes **immediate delivery of business value** with **acceptable technical debt**. The correlation ID functionality is fully implemented and tested. Future refactoring can address architectural purity without impacting current functionality.

---

## Dev Notes

This story requires implementing logging patterns defined in the project's architecture.

*Source: `docs/architecture/logging-best-practices.md`*

### Key Architectural Guidelines

- **Structured Logging**: All new logs should be structured as JSON. The goal is to produce logs like the following example:
  ```json
  {
    "timestamp": "2024-01-15T10:30:00.123Z",
    "level": "INFO",
    "logger": "com.musichub.producer.application.service.RegisterTrackService",
    "message": "Track successfully registered",
    "correlation_id": "req-123-456",
    "business_context": {
      "producer_code": "FRLA1",
      "isrc": "FRLA12400001",
      "operation": "track_registration"
    }
  }
  ```

- **Correlation IDs**: A `correlation_id` must be passed through the request flow and included in every log statement to allow for easy tracing.

- **Exception Handling**: Adhere strictly to the "Either log OR rethrow" pattern. Since `RegisterTrackService` is in the **Application Layer**, it may log an exception and then rethrow it for the REST adapter layer to handle and convert into an HTTP response.

### Implementation Summary

**Correlation ID Integration:**
- Added `correlationId` parameter to `RegisterTrackUseCase.registerTrack()` method
- Propagated correlation ID through all service methods and logging statements
- Updated REST adapter to pass correlation ID from request context

**Structured Logging:**
- Implemented MDC (Mapped Diagnostic Context) for structured logging
- Added `business_context` with producer_code, isrc, and operation details
- Used JSON-compatible logging patterns for better observability

**Performance Metrics:**
- Added timing measurements for total method execution time
- Added timing measurements for external API calls
- Logged execution times at INFO level for monitoring

**Log Level Optimization:**
- Promoted critical business flow logs from DEBUG to INFO level
- Maintained technical details at appropriate DEBUG/TRACE levels
- Ensured essential production monitoring information is visible

### Testing

- **Unit Tests**: Updated all existing `RegisterTrackServiceTest` cases to work with new method signature
- **Integration Tests**: Created `RegisterTrackServiceLoggingIntegrationTest` for end-to-end verification
- **Verification**: All tests pass, confirming correlation IDs, structured logging, and performance metrics work correctly

---

## Change Log

| Date | Version | Description | Author |
| :--- | :--- | :--- | :--- |
| 2025-09-13 | 1.0 | Initial draft of the story. | Bob (Scrum Master) |
| 2025-09-13 | 1.1 | Implementation completed - correlation IDs, structured logging, performance metrics, and updated tests. | James (Dev) |
