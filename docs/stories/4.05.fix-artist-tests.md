# User Story: 4.05 - Fix Artist Tests

## Status
Draft

## Story

**As a** Developer maintaining the Music Hub system,
**I want** to fix all failing unit tests in ArtistEnrichmentService and ArtistService,
**so that** the codebase quality is maintained and artist enrichment functionality works correctly.

### Pre-requisites
* ArtistEnrichmentService and ArtistService implementations exist
* Unit tests are currently failing (17 out of 18 tests in ArtistEnrichmentServiceTest, 6 out of 7 in ArtistServiceTest)
* Understanding of artist enrichment logic and source hierarchy

## Acceptance Criteria

#### AC1: Fix ArtistEnrichmentService Tests
**Given** 17 failing tests in ArtistEnrichmentServiceTest
**When** the fixes are implemented
**Then** all 18 tests in ArtistEnrichmentServiceTest should pass

#### AC2: Fix ArtistService Tests
**Given** 6 failing tests in ArtistServiceTest
**When** the fixes are implemented
**Then** all 7 tests in ArtistServiceTest should pass

#### AC3: Artist Enrichment Logic
**Given** artist enrichment from external APIs
**When** the enrichment process runs
**Then** the logic should work correctly with proper source hierarchy (MANUAL > TIDAL > SPOTIFY > DEEZER > APPLE_MUSIC)

#### AC4: Artist Status Management
**Given** artists in PROVISIONAL status
**When** enrichment completes successfully
**Then** artists should transition to VERIFIED status

#### AC5: Error Handling
**Given** enrichment failures or API errors
**When** exceptions occur
**Then** they should be properly propagated and handled in tests

#### AC6: Artist Contributions
**Given** multiple artists collaborating on tracks
**When** contributions are processed
**Then** the logic should correctly determine multiple artist contributions

## Tasks / Subtasks

- [ ] **Task 1: Analyze failing ArtistEnrichmentService tests (AC: 1, 3, 4, 5)**
  - [ ] Review all 17 failing tests in ArtistEnrichmentServiceTest
  - [ ] Identify root causes of failures
  - [ ] Document specific issues with artist status transitions
  - [ ] Document issues with source hierarchy logic
  - [ ] Document error handling problems

- [ ] **Task 2: Fix artist enrichment logic (AC: 1, 3, 4)**
  - [ ] Fix artist status transition from PROVISIONAL to VERIFIED
  - [ ] Implement correct source hierarchy priority (MANUAL > TIDAL > SPOTIFY > DEEZER > APPLE_MUSIC)
  - [ ] Fix findArtistByName method calls on appropriate ports
  - [ ] Ensure proper data merging logic

- [ ] **Task 3: Fix error handling in tests (AC: 1, 5)**
  - [ ] Correct exception propagation in enrichment service
  - [ ] Fix error test cases that are currently failing
  - [ ] Ensure proper error handling for API failures

- [ ] **Task 4: Analyze failing ArtistService tests (AC: 2, 6)**
  - [ ] Review all 6 failing tests in ArtistServiceTest
  - [ ] Identify issues with space preservation in artist names
  - [ ] Document problems with collaboration contribution logic
  - [ ] Find unnecessary Mockito stubbings causing exceptions

- [ ] **Task 5: Fix ArtistService logic (AC: 2, 6)**
  - [ ] Fix space preservation in artist names
  - [ ] Correct logic for determining multiple artist contributions
  - [ ] Remove unnecessary Mockito stubbings
  - [ ] Fix UnnecessaryStubbingException errors

- [ ] **Task 6: Run comprehensive tests (AC: 1, 2)**
  - [ ] Execute all ArtistEnrichmentServiceTest tests
  - [ ] Execute all ArtistServiceTest tests
  - [ ] Verify all tests pass (18/18 and 7/7)
  - [ ] Run integration tests to ensure no regressions

- [ ] **Task 7: Code review and cleanup (AC: 1, 2)**
  - [ ] Review all code changes for consistency
  - [ ] Ensure proper logging and error messages
  - [ ] Clean up any temporary debug code
  - [ ] Update comments if needed

## Dev Notes

### Previous Story Insights
- Story 4.04 (Architecture Coherence Refactoring) is currently blocked by this story
- Recent changes to CDI injection may have affected test mocking
- Artist enrichment logic was recently modified for bug fixes

### Data Models
Current data models from data-models.md:
- Artist: {id, name, status, country?, sources[], contributions[], submissionDate, producerIds[]}
- Status values: PROVISIONAL, VERIFIED, REJECTED
- Sources hierarchy: MANUAL > TIDAL > SPOTIFY > DEEZER > APPLE_MUSIC

[Source: docs/architecture/data-models.md]

### API Specifications
No specific API changes required - this is internal logic fixes for existing functionality.

### Component Specifications
- ArtistEnrichmentService: Handles enrichment from external APIs
- ArtistService: Core artist management service
- ArtistReconciliationPort: Interface for artist data reconciliation
- MusicPlatformPort: Interface for external music platform APIs

### File Locations
Based on project structure from source-tree.md:
- Artist components: apps/artist/artist-application/src/main/java/com/musichub/artist/application/
- Artist domain: apps/artist/artist-domain/src/main/java/com/musichub/artist/domain/
- Tests: apps/artist/artist-application/src/test/java/com/musichub/artist/application/

[Source: docs/architecture/source-tree.md]

### Testing Requirements
From testing-strategy.md:
- Unit tests for domain logic and services using JUnit 5, Mockito, AssertJ
- Maintain 80% code coverage target with Jacoco
- Use @DisplayName for all test methods
- Mock external dependencies properly
- Avoid unnecessary stubbings that cause UnnecessaryStubbingException

[Source: docs/architecture/testing-strategy.md]

### Technical Constraints
From tech-stack.md:
- Java 21 with Quarkus 3.25.3
- CDI for dependency injection
- Mockito for unit test mocking
- JUnit 5 for testing framework

[Source: docs/architecture/tech-stack.md]

## Testing

### Testing Standards
- **Unit Tests**: Validate atomic logic in isolation using JUnit 5, Mockito, AssertJ
- **Integration Tests**: Test complete flows using H2 in-memory database
- **Code Coverage**: Maintain 80% coverage target with Jacoco
- **Test Documentation**: Use @DisplayName for all test methods
- **Mock Management**: Properly configure Mockito to avoid UnnecessaryStubbingException
- **Test Location**: Co-located with implementation (src/test/java following same package structure)

### Specific Testing Requirements for This Story
- Fix all existing unit tests without breaking functionality
- Ensure proper mocking of external dependencies
- Test error scenarios and edge cases
- Validate artist enrichment logic with different source priorities
- Test artist status transitions
- Verify contribution logic for multiple artists

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-20 | 1.0 | Initial story creation for fixing artist unit tests | Scrum Master |

## Dev Agent Record

### Agent Model Used
[To be populated by development agent]

### Debug Log References
[To be populated by development agent]

### Completion Notes List
[To be populated by development agent]

### File List
[To be populated by development agent]

## QA Results
[To be populated by QA agent]