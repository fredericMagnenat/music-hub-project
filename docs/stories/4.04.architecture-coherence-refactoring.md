# User Story: 4.04 - Architecture Coherence Refactoring

## Status
Blocked - Waiting for Story 4.05 (Fix Artist Tests) completion

## Story

**As a** Developer maintaining the Music Hub system,
**I want** to refactor the Producer and Artist contexts to follow consistent hexagonal architecture patterns,
**so that** the codebase is more maintainable, testable, and adheres to our architectural standards.

### Pre-requisites
* This story depends on existing Producer and Artist contexts being functional
* Requires understanding of hexagonal architecture patterns
* Access to current service implementations in both contexts

## Acceptance Criteria

#### AC1: Create TrackEnrichmentUseCase and TrackEnrichmentService
**Given** the Producer context needs to follow hexagonal architecture
**When** the refactoring is implemented
**Then** TrackEnrichmentUseCase and TrackEnrichmentService should be created following the pattern: Service → UseCase (Port) → EnrichmentService → PlatformPort

#### AC2: Create ArtistEnrichmentUseCase
**Given** the Artist context needs to follow hexagonal architecture
**When** the refactoring is implemented
**Then** ArtistEnrichmentUseCase should be created following the same pattern

#### AC3: Refactor ProducerService
**Given** RegisterTrackService currently calls MusicPlatformPort directly
**When** the refactoring is implemented
**Then** ProducerService should use TrackEnrichmentUseCase instead of direct port calls

#### AC4: Refactor ArtistService
**Given** ArtistService currently calls ArtistEnrichmentService directly
**When** the refactoring is implemented
**Then** ArtistService should use ArtistEnrichmentUseCase instead of direct service calls

#### AC5: Move business logic to domain entities
**Given** some business logic may be in application services
**When** the refactoring is implemented
**Then** business logic should be properly delegated to domain entities where appropriate

#### AC6: Unit tests for new components
**Given** new use cases and services are created
**When** the refactoring is implemented
**Then** comprehensive unit tests should be created for all new components

#### AC7: Documentation update
**Given** architecture changes are made
**When** the refactoring is implemented
**Then** architecture documentation should be updated to reflect the new patterns

## Tasks / Subtasks

- [ ] **Task 1: Create TrackEnrichmentUseCase (AC: 1, 3)**
  - [ ] Create TrackEnrichmentUseCase interface in producer-application ports.in
  - [ ] Define methods for track metadata enrichment
  - [ ] Ensure proper dependency injection setup

- [ ] **Task 2: Create TrackEnrichmentService (AC: 1, 3)**
  - [ ] Create TrackEnrichmentService implementing the use case
  - [ ] Move track enrichment logic from RegisterTrackService to TrackEnrichmentService
  - [ ] Implement proper error handling and logging

- [ ] **Task 3: Create ArtistEnrichmentUseCase (AC: 2, 4)**
  - [ ] Create ArtistEnrichmentUseCase interface in artist-application ports.in
  - [ ] Define methods for artist enrichment operations
  - [ ] Ensure consistency with TrackEnrichmentUseCase pattern

- [ ] **Task 4: Refactor RegisterTrackService (AC: 3)**
  - [ ] Remove direct MusicPlatformPort calls from RegisterTrackService
  - [ ] Inject and use TrackEnrichmentUseCase instead
  - [ ] Update method signatures and flow as needed

- [ ] **Task 5: Refactor ArtistService (AC: 4)**
  - [ ] Remove direct ArtistEnrichmentService calls from ArtistService
  - [ ] Inject and use ArtistEnrichmentUseCase instead
  - [ ] Update method signatures and flow as needed

- [ ] **Task 6: Domain logic delegation (AC: 5)**
  - [ ] Review current business logic in application services
  - [ ] Move appropriate logic to domain entities (Producer, Artist, Track)
  - [ ] Ensure domain invariants are properly enforced

- [ ] **Task 7: Unit testing (AC: 6)**
  - [ ] Create unit tests for TrackEnrichmentUseCase and TrackEnrichmentService
  - [ ] Create unit tests for ArtistEnrichmentUseCase
  - [ ] Create integration tests for refactored services
  - [ ] Ensure 80% code coverage target is maintained

- [ ] **Task 8: Documentation update (AC: 7)**
  - [ ] Update architectural-and-design-patterns.md with new patterns
  - [ ] Add code examples showing the new architecture
  - [ ] Update any relevant diagrams or documentation

## Dev Notes

### Previous Story Insights
- Story 4.03 (Version Compatibility Matrix) is currently in "Ready" status, so this refactoring can proceed independently
- No specific technical challenges noted from previous stories that would impact this refactoring

### Data Models
Current data models from data-models.md:
- Producer: {id, producerCode, name?, tracks[]}
- Track: {id, isrc, title, credits[], status, sources[], submissionDate}
- Artist: {id, name, status, country?, sources[], contributions[], submissionDate, producerIds[]}

[Source: docs/architecture/data-models.md]

### API Specifications
No specific API changes required for this refactoring - it's internal architecture improvement.

### Component Specifications
New components to be created:
- TrackEnrichmentUseCase (interface)
- TrackEnrichmentService (implementation)
- ArtistEnrichmentUseCase (interface)

### File Locations
Based on project structure from source-tree.md:
- Producer components: apps/producer/producer-application/src/main/java/com/musichub/producer/application/
- Artist components: apps/artist/artist-application/src/main/java/com/musichub/artist/application/
- Tests: Follow existing pattern in respective test directories

[Source: docs/architecture/source-tree.md]

### Testing Requirements
From testing-strategy.md:
- Unit tests for domain logic and services
- Integration tests for complete flows
- 80% code coverage target using Jacoco
- JUnit 5 with @DisplayName annotations
- ArchUnit for architectural rule validation

[Source: docs/architecture/testing-strategy.md]

### Technical Constraints
From tech-stack.md:
- Java 21 with Quarkus 3.25.3
- Hexagonal Architecture with Ports & Adapters pattern
- Domain-Driven Design principles
- Immutable domain objects
- CDI for dependency injection

[Source: docs/architecture/tech-stack.md]

### Architectural Patterns
From architectural-and-design-patterns.md:
- Hexagonal Architecture (Ports & Adapters)
- Event-Driven Architecture
- Domain-Driven Design (DDD) Patterns: Aggregate, Repository, Value Object, Factory
- Application services should not contain business logic - delegate to domain

[Source: docs/architecture/architectural-and-design-patterns.md]

### Coding Standards
From coding-standards.md:
- Domain immutability: Domain objects must be immutable
- No logic in adapters: REST controllers must be thin
- Application use case entry points: Always go through use case interfaces
- Value Objects for domain concepts with rules/constraints

[Source: docs/architecture/coding-standards.md]

## Testing

### Testing Standards
- **Unit Tests**: Validate atomic logic in isolation using JUnit 5, Mockito, AssertJ
- **Integration Tests**: Test complete flows using H2 in-memory database and WireMock for external services
- **Code Coverage**: Maintain 80% coverage target with Jacoco
- **Test Documentation**: Use @DisplayName for all test methods
- **Architectural Validation**: Use ArchUnit to enforce hexagonal architecture rules
- **Test Location**: Co-located with implementation (src/test/java following same package structure)

### Specific Testing Requirements for This Story
- Unit tests for new UseCase interfaces and implementations
- Mock external dependencies (MusicPlatformPort, ArtistReconciliationPort)
- Test error handling and edge cases
- Validate that business logic is properly delegated to domain entities
- Integration tests to ensure refactored services work end-to-end

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-20 | 1.0 | Initial story creation for architecture coherence refactoring | Scrum Master |
| 2025-01-20 | 1.1 | Story recreated after being lost | Assistant |
| 2025-01-20 | 1.2 | Story blocked pending completion of Story 4.05 (Fix Artist Tests) | Scrum Master |

## Dev Agent Record

### Agent Model Used
[To be populated by development agent]

### Debug Log References
[To be populated by development agent]

### Completion Notes List
[To be populated by development agent]

### File List
[To be populated by development agent]

## QA Results
[To be populated by QA agent]