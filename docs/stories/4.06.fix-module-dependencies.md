# User Story: 4.06 - Fix Module Dependencies

## Status
Approved

## Story

**As a** Developer maintaining the Music Hub system,
**I want** to fix the architectural dependency violations between SPI and Application layers,
**so that** the codebase follows clean architecture principles and tests can run properly.

### Pre-requisites
* Artist SPI adapter module exists with TidalArtistClientTest
* Artist Application module exists with ArtistReconciliationPort interface
* Current architecture violates dependency inversion principle
* Tests are failing due to missing class dependencies

## Acceptance Criteria

#### AC1: Fix SPI Module Dependencies
**Given** the artist-adapter-spi module has dependency violations
**When** the dependencies are corrected
**Then** the module only depends on domain and shared-kernel layers

#### AC2: Resolve Test Execution Issues
**Given** TidalArtistClientTest fails with NoClassDefFoundError
**When** the architectural issues are resolved
**Then** all tests in the SPI module can execute successfully

#### AC3: Maintain Clean Architecture
**Given** the current layered architecture
**When** dependencies are restructured
**Then** dependency inversion principle is respected (inner layers don't depend on outer layers)

#### AC4: Preserve Existing Functionality
**Given** the current implementation works functionally
**When** the architecture is refactored
**Then** no functional changes are introduced, only structural improvements

## Tasks / Subtasks

- [ ] **Task 1: Analyze Current Dependencies (AC: 1, 3)**
  - [ ] Review current Maven dependencies between modules
  - [ ] Identify all dependency violations in SPI layer
  - [ ] Document the clean architecture violations
  - [ ] Map out the correct dependency flow

- [ ] **Task 2: Move ArtistReconciliationPort to Domain Layer (AC: 1, 2, 3)**
  - [ ] Create ArtistReconciliationPort interface in artist-domain module
  - [ ] Move interface from application.ports.out to domain.ports.out package
  - [ ] Update SPI module imports to reference domain interface
  - [ ] Ensure SPI module only depends on domain and shared-kernel layers

- [ ] **Task 3: Update Application Module References (AC: 2, 4)**
  - [ ] Update ArtistEnrichmentService to import from domain layer
  - [ ] Update any other Application layer classes using ArtistReconciliationPort
  - [ ] Ensure dependency injection still works correctly
  - [ ] Verify all application tests still pass

- [ ] **Task 4: Validate Architecture Compliance (AC: 3, 4)**
  - [ ] Run architecture compliance checks
  - [ ] Verify dependency inversion principle is followed
  - [ ] Ensure no circular dependencies exist
  - [ ] Test that all modules can be built independently

- [ ] **Task 5: Update Documentation (AC: 1, 3)**
  - [ ] Update architecture documentation to reflect changes
  - [ ] Document the corrected dependency flow
  - [ ] Update any relevant design documents

## Dev Notes

### Previous Story Insights
- Story 4.05 identified SonarQube violations that were corrected
- During testing, dependency issues were discovered in TidalArtistClientTest
- The SPI module is importing classes from the Application layer, violating clean architecture

### Technical Context
- **Current Issue**: `artist-adapter-spi` module depends on `com.musichub.artist.application.ports.out.ArtistReconciliationPort`
- **Architecture Violation**: SPI (infrastructure) layer should not depend on Application layer
- **Clean Architecture**: Dependencies should flow inward (Infrastructure → Domain, not Infrastructure → Application)
- **Impact**: Tests cannot run due to missing class dependencies

### Component Specifications
- **SPI Module**: `artist-adapter-spi` - should only depend on domain and shared-kernel
- **Application Module**: `artist-application` - contains use cases and application services
- **Domain Module**: `artist-domain` - contains business logic and domain models
- **ArtistReconciliationPort**: Currently in Application layer, may need to be moved to Domain

### File Locations
Based on project structure:
- SPI Module: `apps/artist/artist-adapters/artist-adapter-spi/`
- Application Module: `apps/artist/artist-application/`
- Domain Module: `apps/artist/artist-domain/`
- Test File: `apps/artist/artist-adapters/artist-adapter-spi/src/test/java/com/musichub/artist/adapter/spi/TidalArtistClientTest.java`

## Testing

### Testing Standards
- **Unit Tests**: Validate SPI implementations work correctly with domain interfaces
- **Integration Tests**: Ensure proper interaction between layers after refactoring
- **Architecture Tests**: Verify dependency rules are followed
- **Test Location**: Co-located with implementation (src/test/java following same package structure)

### Specific Testing Requirements for This Story
- Fix existing TidalArtistClientTest execution issues
- Add architecture compliance tests if needed
- Ensure no functional regressions in SPI implementations
- Validate that dependency injection still works correctly

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-20 | 1.0 | Initial story creation for fixing module dependency violations | Dev Agent |
| 2025-09-20 | 1.1 | Root cause analysis completed - ArtistReconciliationPort needs to be moved to Domain layer | Dev Agent |

## Dev Agent Record

### Agent Model Used
Dev Agent (Full Stack Developer)

### Debug Log References
- TidalArtistClientTest dependency analysis
- Maven dependency tree analysis
- Architecture violation identification

### Completion Notes List
- Identified dependency violation: SPI module importing Application layer classes
- NoClassDefFoundError in TidalArtistClientTest due to missing ArtistReconciliationPort
- Clean architecture principle violation: Infrastructure should not depend on Application layer
- Root cause: ArtistReconciliationPort interface is in Application layer but implemented by SPI layer
- Solution: Move ArtistReconciliationPort to Domain layer to respect dependency inversion principle

### File List
- apps/artist/artist-adapters/artist-adapter-spi/src/test/java/com/musichub/artist/adapter/spi/TidalArtistClientTest.java
- apps/artist/artist-application/src/main/java/com/musichub/artist/application/ports/out/ArtistReconciliationPort.java