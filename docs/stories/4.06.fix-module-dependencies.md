# User Story: 4.06 - Fix Module Dependencies

## Status
Approved

## Story

**As a** Developer maintaining the Music Hub system,
**I want** to fix the Maven dependency violations between SPI and Application layers,
**so that** the codebase follows hexagonal architecture principles and tests can run properly.

### Pre-requisites
* Artist SPI adapter module exists with TidalArtistClientTest
* Artist Application module exists with ArtistReconciliationPort interface in ports.out
* SPI module has unnecessary Maven dependency to Application module
* Tests are failing due to architectural dependency issues

## Acceptance Criteria

#### AC1: Remove Unnecessary Maven Dependencies
**Given** the artist-adapter-spi module depends on artist-application
**When** the Maven dependencies are corrected
**Then** the SPI module only depends on domain, shared-kernel, and external libraries

#### AC2: Resolve Test Execution Issues
**Given** TidalArtistClientTest fails with dependency issues
**When** the Maven dependencies are fixed
**Then** all tests in the SPI module can execute successfully

#### AC3: Maintain CDI Injection
**Given** the current CDI-based dependency injection
**When** dependencies are restructured
**Then** ArtistReconciliationPort implementations are still discovered via CDI

#### AC4: Preserve Existing Functionality
**Given** the current implementation works functionally
**When** the architecture is refactored
**Then** no functional changes are introduced, only structural improvements

## Tasks / Subtasks

- [ ] **Task 1: Analyze Current Dependencies (AC: 1, 3)**
  - [ ] Review current Maven dependencies between artist modules
  - [ ] Identify why SPI module depends on Application module
  - [ ] Verify that CDI injection works without direct Maven dependency
  - [ ] Document the current dependency flow and issues

- [ ] **Task 2: Remove SPI Maven Dependency to Application (AC: 1, 2)**
  - [ ] Remove artist-application dependency from artist-adapter-spi/pom.xml
  - [ ] Ensure SPI module can still compile (interface in application is not needed at compile time)
  - [ ] Update any necessary imports or dependencies
  - [ ] Test that SPI module builds independently

- [ ] **Task 3: Verify CDI Injection Still Works (AC: 2, 3)**
  - [ ] Run TidalArtistClientTest to ensure it passes
  - [ ] Verify that ArtistEnrichmentService can still inject reconciliation ports
  - [ ] Test end-to-end functionality in integration tests
  - [ ] Ensure no runtime dependency issues

- [ ] **Task 4: Validate Architecture Compliance (AC: 3, 4)**
  - [ ] Run Maven build to ensure all modules compile
  - [ ] Verify hexagonal architecture is respected (infrastructure doesn't depend on application)
  - [ ] Test that modules can be built independently
  - [ ] Run all tests to ensure no regressions

- [ ] **Task 5: Update Documentation (AC: 1, 3)**
  - [ ] Update architecture documentation to reflect corrected dependency flow
  - [ ] Document the CDI-based dependency injection pattern
  - [ ] Update any relevant design documents

## Dev Notes

### Previous Story Insights
- Story 4.05 identified SonarQube violations that were corrected
- During testing, dependency issues were discovered in TidalArtistClientTest
- The SPI module is importing classes from the Application layer, violating clean architecture

### Technical Context
- **Current Issue**: `artist-adapter-spi` module has Maven dependency on `artist-application`
- **Architecture Issue**: Infrastructure layer should not have compile-time dependency on Application layer
- **Hexagonal Architecture**: Dependencies should flow inward, infrastructure discovered via CDI
- **Impact**: Tests fail due to unnecessary tight coupling between layers

### Component Specifications
- **SPI Module**: `artist-adapter-spi` - should only depend on domain, shared-kernel, and external APIs
- **Application Module**: `artist-application` - contains use cases, ports, and application services
- **Domain Module**: `artist-domain` - contains business logic and domain models
- **ArtistReconciliationPort**: Remains in Application layer (convention), discovered via CDI

### File Locations
Based on project structure:
- SPI Module: `apps/artist/artist-adapters/artist-adapter-spi/`
- Application Module: `apps/artist/artist-application/`
- Domain Module: `apps/artist/artist-domain/`
- Test File: `apps/artist/artist-adapters/artist-adapter-spi/src/test/java/com/musichub/artist/adapter/spi/TidalArtistClientTest.java`

## Testing

### Testing Standards
- **Unit Tests**: Validate SPI implementations work correctly with domain interfaces
- **Integration Tests**: Ensure proper interaction between layers after refactoring
- **Architecture Tests**: Verify dependency rules are followed
- **Test Location**: Co-located with implementation (src/test/java following same package structure)

### Specific Testing Requirements for This Story
- Fix existing TidalArtistClientTest execution issues
- Add architecture compliance tests if needed
- Ensure no functional regressions in SPI implementations
- Validate that dependency injection still works correctly

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-20 | 1.0 | Initial story creation for fixing module dependency violations | Dev Agent |
| 2025-09-20 | 1.1 | Root cause analysis completed - Maven dependency issue identified, ports stay in application | Scrum Master |

## Dev Agent Record

### Agent Model Used
Scrum Master (Story Preparation Specialist)

### Debug Log References
- Architecture convention analysis (ports in application layer)
- Maven dependency tree analysis
- CDI injection pattern verification

### Completion Notes List
- Identified Maven dependency issue: SPI module unnecessarily depends on Application module
- Tests fail due to tight coupling between infrastructure and application layers
- Hexagonal architecture violation: Infrastructure should be independent of application
- Root cause: Maven pom.xml includes application dependency for interface that's not needed at compile time
- Solution: Remove Maven dependency, rely on CDI for runtime discovery of implementations

### File List
- apps/artist/artist-adapters/artist-adapter-spi/pom.xml (to remove application dependency)
- apps/artist/artist-adapters/pom.xml (parent pom with application dependency)
- apps/artist/artist-application/src/main/java/com/musichub/artist/application/ports/out/ArtistReconciliationPort.java (stays in application)
- apps/artist/artist-application/src/main/java/com/musichub/artist/application/config/ArtistReconciliationConfig.java (CDI injection)