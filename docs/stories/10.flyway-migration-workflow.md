# Story 10: Implement Flyway Migration Generation Workflow

## Status
Draft

## Story
**As a** Developer,
**I want** to have an automated workflow for generating Flyway migrations based on JPA entity changes,
**so that** I can efficiently create and validate database schema changes following the documented migration strategy.

## Acceptance Criteria
1. **Hibernate Schema Export Plugin Configuration**: Add and configure the `hibernate-enhance-maven-plugin` in `apps/bootstrap/pom.xml` with schema export capability as specified in the documentation.

2. **Development Profile Setup**: Create a `dev-schema` profile in `application.properties` that:
   - Allows Hibernate to generate schema with `quarkus.hibernate-orm.database.generation=create`
   - Disables Flyway migration at startup with `quarkus.flyway.migrate-at-start=false`
   - Uses a temporary database or H2 for schema generation

3. **Migration Generation Script**: Create and make executable the `scripts/generate-migration.sh` script that:
   - Takes migration description and context (producer/artist) as parameters
   - Validates context and determines appropriate version ranges
   - Creates migration directory structure if needed
   - Finds next sequential version number within context range
   - Generates migration file with helpful template and comments
   - Includes generated schema reference if available
   - Provides clear next steps instructions

4. **Version Range Validation**: Ensure the script enforces version range allocation:
   - Producer context: V1-V99
   - Artist context: V100-V199
   - Prevents version conflicts between contexts

5. **Migration File Template**: Generated migrations should include:
   - Context and description header with metadata
   - Common migration pattern examples as comments
   - Generated schema reference (when available)
   - Rollback instructions in comments

## Tasks / Subtasks

- [ ] **Configure Hibernate Schema Export Plugin** (AC: 1)
  - [ ] Add `hibernate-enhance-maven-plugin` to `apps/bootstrap/pom.xml`
  - [ ] Configure schema export execution with PostgreSQL dependency
  - [ ] Set manual execution phase and output file location
  - [ ] Test plugin execution with `mvn hibernate-enhance:schema-export`

- [ ] **Create Development Schema Profile** (AC: 2)
  - [ ] Add `%dev-schema` profile to `apps/bootstrap/src/main/resources/application.properties`
  - [ ] Configure Hibernate to create schema instead of validate
  - [ ] Disable Flyway auto-migration for schema generation mode
  - [ ] Set temporary database configuration
  - [ ] Add optional H2 alternative profile `%dev-schema-h2`
  - [ ] Test profile activation and schema generation

- [ ] **Create Migration Generation Script** (AC: 3, 4, 5)
  - [ ] Create `scripts/` directory if it doesn't exist
  - [ ] Write `scripts/generate-migration.sh` with parameter validation
  - [ ] Implement context validation (producer/artist) and version range logic
  - [ ] Add migration directory creation and version number detection
  - [ ] Implement migration file creation with template
  - [ ] Add generated schema integration from plugin output
  - [ ] Include helpful output messages and next steps
  - [ ] Make script executable with `chmod +x`
  - [ ] Test script with both producer and artist contexts

- [ ] **Documentation and Validation** (AC: 1, 2, 3, 4, 5)
  - [ ] Test complete workflow end-to-end
  - [ ] Verify script handles edge cases (no existing migrations, version range limits)
  - [ ] Validate generated migration file format and content
  - [ ] Ensure script output matches documentation examples
  - [ ] Test schema export integration and generated references

- [ ] **Integration Testing** (AC: 1, 2, 3, 4, 5)
  - [ ] Test migration workflow with actual entity changes
  - [ ] Verify generated migrations apply successfully with Flyway
  - [ ] Test both PostgreSQL and H2 schema generation profiles
  - [ ] Validate version range enforcement prevents conflicts

## Dev Notes

### Architecture Context
This story implements the workflow documented in `docs/architecture/database-migration-flyway.md` sections 4.1-4.3. The implementation follows the established Flyway multi-module architecture pattern where each bounded context manages its own migrations within allocated version ranges.

**Key Technical Requirements from Architecture:**
- **Version Range Allocation**: Producer (V1-V99), Artist (V100-V199) as specified in [Source: database-migration-flyway.md#versioning-conventions]
- **Migration File Naming**: `V{VERSION}__{DESCRIPTION}.sql` format with snake_case descriptions [Source: database-migration-flyway.md#migration-naming-convention]
- **Schema Export Plugin**: Use `hibernate-enhance-maven-plugin` with PostgreSQL driver dependency [Source: database-migration-flyway.md#hibernate-schema-export-plugin]
- **Development Profiles**: Separate profile for schema generation to isolate from normal dev workflow [Source: database-migration-flyway.md#development-profile-for-schema-generation]

### Project Structure Context
Based on [Source: unified-project-structure.md], the migration files will be placed in:
- Producer: `apps/producer/producer-adapters/producer-adapter-persistence/src/main/resources/db/migration/producer/`
- Artist: `apps/artist/artist-adapters/artist-adapter-persistence/src/main/resources/db/migration/artist/`

### Script Workflow Context
The generated script implements the exact workflow from [Source: database-migration-flyway.md#step-by-step-development-workflow]:
1. Developer modifies JPA entity
2. Runs `./scripts/generate-migration.sh "description" "context"`
3. Script generates template migration file
4. Developer edits migration with actual SQL
5. Tests migration with `mvn quarkus:dev`

### Tech Stack Integration
- **Maven Plugin**: Uses `hibernate-enhance-maven-plugin` as defined in tech stack [Source: tech-stack.md]
- **Database**: PostgreSQL 16.x with Flyway for migrations [Source: tech-stack.md]
- **Framework**: Quarkus with profile-based configuration [Source: tech-stack.md]

### Testing Requirements
From [Source: testing-best-practices.md]:
- Test script functionality with both valid and invalid inputs
- Verify version range validation prevents conflicts
- Integration test complete workflow with actual migration
- Validate generated files follow naming conventions
- Test both PostgreSQL and H2 schema generation modes

### Security Considerations
- Script validates input parameters to prevent directory traversal
- Version ranges prevent accidental cross-context conflicts
- Profile-based schema generation isolates from production config

### Performance Considerations
- Schema export uses manual execution to avoid slowing down normal builds
- H2 alternative for faster prototyping
- Generated templates reduce developer cognitive load

## Testing

### Unit Testing
- Test script parameter validation and error handling
- Test version range calculation and conflict detection
- Test migration file template generation

### Integration Testing
- Test complete workflow from entity change to working migration
- Test with both producer and artist contexts
- Test version conflict prevention between contexts
- Verify generated migrations apply successfully with Flyway

### Manual Testing
- Run script with various parameter combinations
- Test schema export plugin execution
- Verify development profile activation and behavior
- Test generated migration file quality and usefulness

## Change Log
| Date | Version | Description | Author |
| --- | --- | --- | --- |
| 2025-08-16 | 0.1 | Initial story creation for Flyway workflow implementation | SM |